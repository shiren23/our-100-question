<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100 Questions for Couples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              rose: {
                50: '#fff1f2',
                100: '#ffe4e6',
                200: '#fecdd3',
                300: '#fda4af',
                400: '#fb7185',
                500: '#f43f5e',
                600: '#e11d48',
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #f8fafc;
      }
      textarea::-webkit-scrollbar {
        width: 8px;
      }
      textarea::-webkit-scrollbar-track {
        background: transparent;
      }
      textarea::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
      }
      .card-content {
        display: none;
      }
      .card-content.show {
        display: block;
      }
      .chevron {
        transition: transform 0.3s;
      }
      .chevron.rotate {
        transform: rotate(180deg);
      }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen pb-20">
        <!-- Header -->
        <header class="sticky top-0 z-10 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
            <div class="max-w-4xl mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-rose-600 flex items-center gap-2">
                            <svg class="w-6 h-6 fill-rose-600" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            100 Questions
                        </h1>
                        <p class="text-xs text-gray-500 mt-1">Record your journey together</p>
                    </div>

                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-end mr-2">
                            <span id="progress-text" class="text-xs font-semibold text-gray-600">0 / 100 Answered</span>
                            <div class="w-32 h-2 bg-gray-100 rounded-full mt-1 overflow-hidden">
                                <div id="progress-bar" class="h-full bg-rose-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <button id="import-btn" class="flex items-center gap-2 bg-white text-slate-700 px-4 py-2 rounded-lg text-sm font-medium border border-gray-200 hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span class="hidden sm:inline">Import Markdown</span>
                            <span class="sm:hidden">Import</span>
                        </button>
                        <button id="export-btn" class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span class="hidden sm:inline">Export Markdown</span>
                            <span class="sm:hidden">Export</span>
                        </button>
                        <input type="file" id="import-file-input" accept=".md,.txt" class="hidden">
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="flex gap-4 mt-4 text-sm font-medium text-gray-500">
                    <button id="filter-all" class="pb-2 border-b-2 border-rose-500 text-rose-600">
                        All Questions
                    </button>
                    <button id="filter-unanswered" class="pb-2 border-b-2 border-transparent hover:text-gray-700">
                        Needs Answer
                    </button>
                    <button id="reset-btn" class="ml-auto pb-2 text-red-400 hover:text-red-600 transition-colors">
                        Reset All
                    </button>
                    <button id="perspective-btn" class="pb-2 text-purple-500 hover:text-purple-700 transition-colors">
                        I'm Male
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="questions-container" class="max-w-4xl mx-auto px-4 py-8 space-y-6">
            <!-- Questions will be rendered here -->
        </main>
    </div>

    <script>
        // ============ DATA & STATE ============
        const STORAGE_KEY = 'couples-100-questions';
        const PERSPECTIVE_KEY = 'couples-perspective';
        let questions = [];
        let expandedId = null;
        let filterMode = 'all';
        let isMalePerspective = true; // true = male user, false = female user

        // Get labels based on perspective
        // Left (blue) = Male's answer, Right (red) = Female's answer
        function getLabels() {
            if (isMalePerspective) {
                // Male user: I'm on the left (blue), partner on the right (red)
                return {
                    leftLabel: 'My Answer',
                    rightLabel: 'Her Answer',
                    leftBadge: 'Me',
                    rightBadge: 'Her',
                    leftPlaceholder: 'What do you think?',
                    rightPlaceholder: 'What does she think?',
                    perspectiveText: "I'm Male"
                };
            } else {
                // Female user: partner on the left (blue), I'm on the right (red)
                return {
                    leftLabel: 'His Answer',
                    rightLabel: 'My Answer',
                    leftBadge: 'Him',
                    rightBadge: 'Me',
                    leftPlaceholder: 'What does he think?',
                    rightPlaceholder: 'What do you think?',
                    perspectiveText: "I'm Female"
                };
            }
        }

        // Generate initial 100 placeholder questions
        function generateInitialQuestions() {
            return Array.from({ length: 100 }, (_, i) => ({
                id: i + 1,
                question: `Question ${i + 1}`,
                myAnswer: '',
                partnerAnswer: ''
            }));
        }

        // Load from localStorage
        function loadQuestions() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    questions = JSON.parse(saved);
                } catch (e) {
                    console.error("Failed to parse saved questions", e);
                    questions = generateInitialQuestions();
                }
            } else {
                questions = generateInitialQuestions();
            }

            // Load perspective
            const savedPerspective = localStorage.getItem(PERSPECTIVE_KEY);
            if (savedPerspective !== null) {
                isMalePerspective = savedPerspective === 'true';
            }
            updatePerspectiveButton();
        }

        function updatePerspectiveButton() {
            const labels = getLabels();
            document.getElementById('perspective-btn').textContent = labels.perspectiveText;
        }

        // Save to localStorage
        function saveQuestions() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(questions));
            updateProgress();
        }

        // Update progress bar
        function updateProgress() {
            const filledCount = questions.filter(q => q.myAnswer.trim() || q.partnerAnswer.trim()).length;
            const progress = Math.round((filledCount / 100) * 100);
            document.getElementById('progress-text').textContent = `${filledCount} / 100 Answered`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        // ============ RENDERING ============
        function isComplete(q) {
            return q.myAnswer.trim() && q.partnerAnswer.trim();
        }

        function renderQuestions() {
            const labels = getLabels();
            const container = document.getElementById('questions-container');
            const filtered = filterMode === 'all'
                ? questions
                : questions.filter(q => !q.myAnswer.trim() || !q.partnerAnswer.trim());

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20 text-gray-400">
                        <p>No questions found in this view.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(q => `
                <div class="card bg-white rounded-xl border transition-all duration-300 ${expandedId === q.id ? 'shadow-lg border-rose-200' : 'shadow-sm border-gray-100 hover:border-rose-100'}" data-id="${q.id}">
                    <!-- Card Header -->
                    <div class="card-header p-4 flex items-start gap-4 cursor-pointer select-none" onclick="toggleCard(${q.id})">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${isComplete(q) ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}">
                            ${q.id}
                        </div>

                        <div class="flex-1 pt-1">
                            <input
                                type="text"
                                value="${escapeHtml(q.question)}"
                                oninput="updateQuestion(${q.id}, 'question', this.value)"
                                onclick="event.stopPropagation()"
                                class="question-input w-full font-medium text-gray-900 border-b border-dashed border-gray-300 focus:border-rose-500 focus:outline-none pb-1 bg-transparent placeholder-gray-400 ${!q.question.startsWith('Question ') ? '' : 'text-gray-500'}"
                                placeholder="Type your question here..."
                            />
                            <div class="mt-1 flex gap-2 status-badges">
                                ${q.myAnswer ? `<span class="inline-block px-2 py-0.5 bg-blue-50 text-blue-600 text-[10px] rounded-full">${labels.leftBadge} ✓</span>` : ''}
                                ${q.partnerAnswer ? `<span class="inline-block px-2 py-0.5 bg-rose-50 text-rose-600 text-[10px] rounded-full">${labels.rightBadge} ✓</span>` : ''}
                            </div>
                        </div>

                        <div class="text-gray-400">
                            <svg class="chevron w-5 h-5 ${expandedId === q.id ? 'rotate' : ''}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="card-content px-4 pb-6 pt-2 grid md:grid-cols-2 gap-6 border-t border-gray-50 ${expandedId === q.id ? 'show' : ''}">
                        <div class="space-y-2">
                            <label class="block text-xs font-semibold text-blue-600 uppercase tracking-wider">
                                ${labels.leftLabel}
                            </label>
                            <textarea
                                oninput="updateQuestion(${q.id}, 'myAnswer', this.value)"
                                placeholder="${labels.leftPlaceholder}"
                                class="w-full min-h-[120px] p-3 rounded-lg bg-blue-50/30 border border-blue-100 focus:border-blue-300 focus:ring-4 focus:ring-blue-500/10 outline-none text-gray-700 text-sm resize-y"
                            >${q.myAnswer}</textarea>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-xs font-semibold text-rose-600 uppercase tracking-wider">
                                ${labels.rightLabel}
                            </label>
                            <textarea
                                oninput="updateQuestion(${q.id}, 'partnerAnswer', this.value)"
                                placeholder="${labels.rightPlaceholder}"
                                class="w-full min-h-[120px] p-3 rounded-lg bg-rose-50/30 border border-rose-100 focus:border-rose-300 focus:ring-4 focus:ring-rose-500/10 outline-none text-gray-700 text-sm resize-y"
                            >${q.partnerAnswer}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ ACTIONS ============
        function toggleCard(id) {
            if (expandedId === id) {
                expandedId = null;
            } else {
                expandedId = id;
            }
            renderQuestions();
        }

        function updateQuestion(id, field, value) {
            const q = questions.find(q => q.id === id);
            if (q) {
                const wasComplete = isComplete(q);
                q[field] = value;
                const nowComplete = isComplete(q);

                saveQuestions();
                if (field !== 'question') {
                    // Update badges without full re-render
                    const labels = getLabels();
                    const card = document.querySelector(`.card[data-id="${id}"]`);
                    if (card) {
                        const badgesContainer = card.querySelector('.status-badges');
                        if (badgesContainer) {
                            badgesContainer.innerHTML = `
                                ${q.myAnswer ? `<span class="inline-block px-2 py-0.5 bg-blue-50 text-blue-600 text-[10px] rounded-full">${labels.leftBadge} ✓</span>` : ''}
                                ${q.partnerAnswer ? `<span class="inline-block px-2 py-0.5 bg-rose-50 text-rose-600 text-[10px] rounded-full">${labels.rightBadge} ✓</span>` : ''}
                            `;
                        }
                        // Update number badge color
                        const numberBadge = card.querySelector('.flex-shrink-0');
                        if (numberBadge) {
                            numberBadge.className = `flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${isComplete(q) ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}`;
                        }
                        // Auto-collapse when question becomes complete
                        if (!wasComplete && nowComplete && expandedId === id) {
                            expandedId = null;
                            const cardContent = card.querySelector('.card-content');
                            const chevron = card.querySelector('.chevron');
                            cardContent.classList.remove('show');
                            chevron.classList.remove('rotate');
                        }
                    }
                }
            }
        }

        function exportMarkdown() {
            const labels = getLabels();
            const partnerLabelExport = isMalePerspective ? 'Partner' : 'Partner';
            const header = `# 100 Questions for Couples - Our Answers\n\nRecorded on: ${new Date().toLocaleDateString()}\n\n---\n\n`;

            const content = questions.map(q => {
                return `### ${q.id}. ${q.question}\n\n**Me:** ${q.myAnswer || '(No answer)'}\n\n**${partnerLabelExport}:** ${q.partnerAnswer || '(No answer)'}\n\n---\n`;
            }).join('\n');

            const blob = new Blob([header + content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '100-questions-answers.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all answers? This cannot be undone.')) {
                questions = generateInitialQuestions();
                saveQuestions();
                renderQuestions();
            }
        }

        function setFilter(mode) {
            filterMode = mode;
            document.getElementById('filter-all').className = `pb-2 border-b-2 transition-colors ${mode === 'all' ? 'border-rose-500 text-rose-600' : 'border-transparent hover:text-gray-700'}`;
            document.getElementById('filter-unanswered').className = `pb-2 border-b-2 transition-colors ${mode === 'unanswered' ? 'border-rose-500 text-rose-600' : 'border-transparent hover:text-gray-700'}`;
            renderQuestions();
        }

        function togglePerspective() {
            isMalePerspective = !isMalePerspective;
            localStorage.setItem(PERSPECTIVE_KEY, isMalePerspective.toString());
            updatePerspectiveButton();
            renderQuestions();
        }

        // ============ IMPORT MARKDOWN ============
        function importMarkdown(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const parsedQuestions = parseMarkdown(content);

                if (parsedQuestions.length === 0) {
                    alert('No questions found in the file. Please check the format.');
                    return;
                }

                const confirmMsg = `Found ${parsedQuestions.length} question(s) in the file.\n\nDo you want to:\n- OK: Merge with existing data\n- Cancel: Replace all data`;
                if (confirm(confirmMsg)) {
                    // Merge mode - only update questions that have content
                    parsedQuestions.forEach(pq => {
                        const existing = questions.find(q => q.id === pq.id);
                        if (existing) {
                            if (pq.question && pq.question !== `Question ${pq.id}`) {
                                existing.question = pq.question;
                            }
                            if (pq.myAnswer) existing.myAnswer = pq.myAnswer;
                            if (pq.partnerAnswer) existing.partnerAnswer = pq.partnerAnswer;
                        }
                    });
                    saveQuestions();
                    renderQuestions();
                    alert(`Successfully imported ${parsedQuestions.length} question(s)!`);
                } else {
                    // Replace mode
                    if (confirm('Replace all existing data with imported data?')) {
                        parsedQuestions.forEach(pq => {
                            const existing = questions.find(q => q.id === pq.id);
                            if (existing) {
                                existing.question = pq.question;
                                existing.myAnswer = pq.myAnswer;
                                existing.partnerAnswer = pq.partnerAnswer;
                            }
                        });
                        saveQuestions();
                        renderQuestions();
                        alert(`Successfully imported ${parsedQuestions.length} question(s)!`);
                    }
                }
            };
            reader.readAsText(file);
        }

        function parseMarkdown(content) {
            const result = [];
            const blocks = content.split(/###\s*/);

            blocks.forEach(block => {
                if (!block.trim()) return;

                // Parse question header: "1. Question text" or "1. Question text"
                const headerMatch = block.match(/^(\d+)\.\s*(.+?)(?:\n|$)/);
                if (!headerMatch) return;

                const id = parseInt(headerMatch[1]);
                const question = headerMatch[2].trim();

                // Parse Me answer - use greedy match then stop at **Partner:**
                const meMatch = block.match(/\*\*Me:\*\*\s*([\s\S]*?)\n\*\*Partner:/);
                let myAnswer = meMatch ? meMatch[1].trim() : '';

                // Parse Partner answer - use greedy match then stop at ---
                const partnerMatch = block.match(/\*\*Partner:\*\*\s*([\s\S]*?)\n---/);
                let partnerAnswer = partnerMatch ? partnerMatch[1].trim() : '';

                // Clean up: if answer is just whitespace, dashes, "(No answer)", or contains labels, treat as empty
                const cleanAnswer = (answer) => {
                    if (!answer) return '';
                    let cleaned = answer.replace(/^[-\s\*]+|[-\s\*]+$/g, '').trim();
                    // Remove any remaining markdown labels like **Partner:** or **Me:**
                    cleaned = cleaned.replace(/\*\*[^:]+:\*\*/g, '').trim();
                    if (cleaned === '(No answer)' || cleaned === '---' || cleaned === '') return '';
                    return cleaned;
                };

                result.push({
                    id,
                    question,
                    myAnswer: cleanAnswer(myAnswer),
                    partnerAnswer: cleanAnswer(partnerAnswer)
                });
            });

            return result;
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            loadQuestions();
            updateProgress();
            renderQuestions();

            // Event listeners
            document.getElementById('export-btn').addEventListener('click', exportMarkdown);
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            document.getElementById('import-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importMarkdown(file);
                    e.target.value = ''; // Reset file input
                }
            });
            document.getElementById('reset-btn').addEventListener('click', clearAll);
            document.getElementById('filter-all').addEventListener('click', () => setFilter('all'));
            document.getElementById('filter-unanswered').addEventListener('click', () => setFilter('unanswered'));
            document.getElementById('perspective-btn').addEventListener('click', togglePerspective);
        });
    </script>
</body>
</html>
